on:
  push:
    branches:
      - main
    paths:
      - 'toolbox/**'
      - '.github/workflows/toolbox.yml'
  schedule:
    - cron:  '0 0 * * MON'
  workflow_dispatch:
permissions: 
    id-token: write
    contents: read
jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix_names: ${{ steps.toolboxes.outputs.matrix_names }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Run script to gather container names
        id: toolboxes
        run: |
          # Collect container names from the toolbox folder
          container_names=()
          for file in toolbox/*Containerfile; do
              # Extract the name (basename of the directory or file without the .Containerfile suffix)
              if [ "$file" != "toolbox/base.Containerfile" ]; then
                  name=$(basename "$file" .Containerfile)
                  container_names+=("$name")
              fi
          done
          # Create JSON array format
          json_array=$(printf '"%s",' "${container_names[@]}")
          json_array="[${json_array%,}]"
          echo "matrix_names=$json_array" >> $GITHUB_OUTPUT
  build-base:
    name: Build Dev Toolbox (base)
    uses: ./.github/workflows/build-image.yml
    with:
      context: .
      image: toolbox-base
      containerfile: toolbox/base.Containerfile
    secrets: inherit
  build-dev:
    name: Build Dev Toolbox (${{ matrix.name }})
    needs: [build-base, prepare]
    strategy:
      matrix:
        name: ${{ fromJson(needs.prepare.outputs.matrix_names) }}
    uses: ./.github/workflows/build-image.yml
    with:
      context: .
      image: toolbox-${{ matrix.name }}
      containerfile: toolbox/${{ matrix.name }}.Containerfile
    secrets: inherit
