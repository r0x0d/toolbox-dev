on:
  push:
    branches:
      - main
    paths:
      - 'toolbox/**'
      - '.github/workflows/toolbox.yml'
  schedule:
    # At the end of every day
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix_names: ${{ steps.toolboxes.outputs.matrix_names }}
      matrix_contexts: ${{ steps.toolboxes.outputs.matrix_contexts }}
      matrix_contexts_short: ${{ steps.toolboxes.outputs.matrix_contexts_short }}
    steps:
      - uses: actions/checkout@v5

      - name: Run script to gather container names and contexts
        id: toolboxes
        run: |
          # Initialize arrays and associative array
          container_names=()
          declare -A container_contexts
          declare -A container_contexts_short

          # Find all Containerfiles except default.Containerfile
          for file in $(find toolbox -type f -name '*.Containerfile'); do
            if [ "$file" != "toolbox/default.Containerfile" ]; then
              # Extract the name (basename without .Containerfile suffix)
              name=$(basename "$file" .Containerfile)

              # Extract the directory path
              dirname=$(dirname "$file")

              # Create short path without "toolbox/" prefix
              short_path="${dirname#toolbox/}"

              # Add to arrays
              container_names+=("$name")
              container_contexts["$name"]="$dirname"
              container_contexts_short["$name"]="$short_path"
            fi
          done

          # Create JSON array for names
          names_json=$(printf '"%s",' "${container_names[@]}")
          names_json="[${names_json%,}]"

          # Create JSON object for contexts mapping
          contexts_json="{"
          for name in "${container_names[@]}"; do
            contexts_json+="\"$name\":\"${container_contexts[$name]}\","
          done
          contexts_json="${contexts_json%,}}"

          # Create JSON object for short contexts mapping
          contexts_short_json="{"
          for name in "${container_names[@]}"; do
            contexts_short_json+="\"$name\":\"${container_contexts_short[$name]}\","
          done
          contexts_short_json="${contexts_short_json%,}}"

          echo "matrix_names=$names_json" >> $GITHUB_OUTPUT
          echo "matrix_contexts=$contexts_json" >> $GITHUB_OUTPUT
          echo "matrix_contexts_short=$contexts_short_json" >> $GITHUB_OUTPUT

          # Debug output
          echo "Found containers:"
          for name in "${container_names[@]}"; do
            echo " $name -> ${container_contexts[$name]} (short: ${container_contexts_short[$name]})"
          done

  build-default:
    name: Build Dev Toolbox (default)
    uses: ./.github/workflows/build-image.yml
    with:
      context: .
      image: default
      containerfile: toolbox/default.Containerfile
    secrets: inherit

  build-dev:
    name: Build Dev Toolbox (${{ fromJson(needs.prepare.outputs.matrix_contexts_short)[matrix.name] }}/${{ matrix.name }})
    needs: [build-default, prepare]
    uses: ./.github/workflows/build-image.yml
    strategy:
      matrix:
        name: ${{ fromJson(needs.prepare.outputs.matrix_names) }}
      fail-fast: false # Don't fail all the workflows if one image fails for some reason.
    with:
      context: .
      image: ${{ fromJson(needs.prepare.outputs.matrix_contexts_short)[matrix.name] }}/${{ matrix.name }}
      containerfile: ${{ fromJson(needs.prepare.outputs.matrix_contexts)[matrix.name] }}/${{ matrix.name }}.Containerfile
    secrets: inherit
