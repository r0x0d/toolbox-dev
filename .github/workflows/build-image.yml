name: Build & Push Image

env:
  REGISTRY: "quay.io/toolbox-dev"
  TAGS: latest ${{ github.sha }}

on:
  workflow_call:
    inputs:
      context:
        required: true
        type: string
      image:
        required: true
        type: string
      containerfile:
        required: true
        type: string
    secrets:
      BOT_USERNAME:
        required: true
      BOT_SECRET:
        required: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Set artifact name
        id: artifact
        run: |
          SAFE_NAME="${IMAGE//\//-}"
          echo "name=image-${SAFE_NAME}" >> $GITHUB_OUTPUT
          echo "tarball=${SAFE_NAME}.tar" >> $GITHUB_OUTPUT
        env:
          IMAGE: ${{ inputs.image }}

      - name: Checkout repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Build image
        uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2
        with:
          context: ${{ inputs.context }}
          image: ${{ inputs.image }}
          tags: ${{ env.TAGS }}
          containerfiles: ${{ inputs.containerfile }}
          layers: true
          oci: true

      - name: Save image to tarball
        run: |
          mkdir -p /tmp/image
          podman save -o /tmp/image/${{ steps.artifact.outputs.tarball }} localhost/${{ inputs.image }}:latest

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/image/${{ steps.artifact.outputs.tarball }}
          retention-days: 1

  security:
    name: Security
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Set artifact name
        id: artifact
        run: |
          SAFE_NAME="${IMAGE//\//-}"
          echo "name=image-${SAFE_NAME}" >> $GITHUB_OUTPUT
          echo "tarball=${SAFE_NAME}.tar" >> $GITHUB_OUTPUT
        env:
          IMAGE: ${{ inputs.image }}

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/image

      - name: Load image for malicious package scan
        run: podman load -i /tmp/image/${{ steps.artifact.outputs.tarball }}

      - name: Download malicious package scripts
        run: |
          curl -sSL https://raw.githubusercontent.com/Red-Hat-Information-Security/Incident-Response/main/npm-malicious-package-check.py -o /tmp/npm-malicious-package-check.py
          curl -sSL https://raw.githubusercontent.com/Red-Hat-Information-Security/Incident-Response/main/shai-hulud-package-check.py -o /tmp/shai-hulud-package-check.py

      - name: Run malicious package scan
        run: |
          podman run --rm \
            -v /tmp/npm-malicious-package-check.py:/tmp/npm-malicious-package-check.py:ro \
            -v /tmp/shai-hulud-package-check.py:/tmp/shai-hulud-package-check.py:ro \
            localhost/${{ inputs.image }}:latest \
            bash -c "
              pip install --quiet requests pyyaml 2>/dev/null || dnf install -y python3-requests python3-pyyaml 2>/dev/null || true
              echo '=== Running npm malicious package checker ==='
              python3 /tmp/npm-malicious-package-check.py
              echo '=== Running Shai-Hulud package checker ==='
              python3 /tmp/shai-hulud-package-check.py
            "

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Set artifact name
        id: artifact
        run: |
          SAFE_NAME="${IMAGE//\//-}"
          echo "name=image-${SAFE_NAME}" >> $GITHUB_OUTPUT
          echo "tarball=${SAFE_NAME}.tar" >> $GITHUB_OUTPUT
        env:
          IMAGE: ${{ inputs.image }}

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/image

      - name: Load image
        run: podman load -i /tmp/image/${{ steps.artifact.outputs.tarball }}

      - name: Test container starts successfully
        run: |
          echo "=== Testing container can start ==="
          podman run --rm localhost/${{ inputs.image }}:latest echo "Container started successfully"

      - name: Test shell availability
        run: |
          echo "=== Testing shell availability ==="
          podman run --rm localhost/${{ inputs.image }}:latest bash -c "echo 'Bash is available'"
          podman run --rm localhost/${{ inputs.image }}:latest sh -c "echo 'Shell is available'"

      - name: Test basic system commands
        run: |
          echo "=== Testing basic system commands ==="
          podman run --rm localhost/${{ inputs.image }}:latest bash -c "
            set -e
            echo 'Testing: whoami'
            whoami
            echo 'Testing: pwd'
            pwd
            echo 'Testing: ls'
            ls -la /
            echo 'Testing: cat /etc/os-release'
            cat /etc/os-release
            echo 'All basic system commands passed!'
          "

      - name: Test network utilities
        run: |
          echo "=== Testing network utilities ==="
          podman run --rm localhost/${{ inputs.image }}:latest bash -c "
            set -e
            echo 'Testing: curl'
            curl --version || echo 'curl not installed (optional)'
            echo 'Testing: ping availability'
            which ping || echo 'ping not installed (optional)'
            echo 'Network utilities check complete!'
          "

      - name: Test package manager
        run: |
          echo "=== Testing package manager ==="
          podman run --rm localhost/${{ inputs.image }}:latest bash -c "
            if command -v dnf &> /dev/null; then
              echo 'DNF is available'
              dnf --version
            elif command -v apt &> /dev/null; then
              echo 'APT is available'
              apt --version
            else
              echo 'No known package manager found'
            fi
          "

  push:
    name: Push
    runs-on: ubuntu-latest
    needs: [security, test]
    steps:
      - name: Set artifact name
        id: artifact
        run: |
          SAFE_NAME="${IMAGE//\//-}"
          echo "name=image-${SAFE_NAME}" >> $GITHUB_OUTPUT
          echo "tarball=${SAFE_NAME}.tar" >> $GITHUB_OUTPUT
        env:
          IMAGE: ${{ inputs.image }}

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/image

      - name: Load and tag image
        run: |
          podman load -i /tmp/image/${{ steps.artifact.outputs.tarball }}
          # Tag with all required tags (the tarball only contains :latest)
          podman tag localhost/${{ inputs.image }}:latest localhost/${{ inputs.image }}:${{ github.sha }}

      - name: Push image
        uses: redhat-actions/push-to-registry@5ed88d269cf581ea9ef6dd6806d01562096bee9c # v2
        id: push
        with:
          username: ${{ secrets.BOT_USERNAME }}
          password: ${{ secrets.BOT_SECRET }}
          image: ${{ inputs.image }}
          registry: ${{ env.REGISTRY }}
          tags: ${{ env.TAGS }}
          extra-args: |
            --format=oci
            --compression-format=zstd:chunked
            --compression-level=19

      - name: Login to registry
        uses: redhat-actions/podman-login@4934294ad0449894bcd1e9f191899d7292469603 # v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.BOT_USERNAME }}
          password: ${{ secrets.BOT_SECRET }}
          auth_file_path: /tmp/auth.json

      - uses: sigstore/cosign-installer@d7543c93d881b35a8faa02e8e3605f69b7a1ce62 # v3.10.0

      - name: Sign image
        run: |
          cosign sign -y --key env://COSIGN_PRIVATE_KEY ${{ env.REGISTRY }}/${{ inputs.image }}@${{ steps.push.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "false"
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
